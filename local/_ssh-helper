#!/bin/bash

AGENT=~/.ssh-agent
WHO=$(whoami)
SSH_AGENT_PID=-1

rm -f ~/.ssh-agent

unset SSH_AUTH_SOCK; export SSH_AUTH_SOCK
unset SSH_AGENT_PID; export SSH_AGENT_PID

PSID=$(pidof ssh-agent)
if [ -z "$PSID" ]; then
	ssh-agent | grep -v echo > ~/.ssh-agent
	PSID=$(pidof ssh-agent)
	echo "Starting new ssh-agent ($PSID)"
else
	echo "Using existing ssh-agent ($PSID)"
fi

DIR=$(/bin/ls -l /tmp | grep $WHO | grep "\<ssh-..........\>" | sed "s/.* //g")
SOCK=$(/bin/ls /tmp/$DIR)

if [ ! -z "$PSID" ]; then
	if [ -f $AGENT ]; then
		source $AGENT
	fi

	if [ "$SSH_AGENT_PID" != "$PSID" ]; then
		echo "SSH_AUTH_SOCK=/tmp/$DIR/$SOCK; export SSH_AUTH_SOCK" > $AGENT
		echo "SSH_AGENT_PID=$PSID; export SSH_AGENT_PID" >> $AGENT

		source $AGENT
	fi

	ADD=$(ssh-add -l)

	if [ "$ADD" = "The agent has no identities." ]; then
		ssh-add $(find ~/.ssh -name \*.pub | sed 's/\.pub//')
		source $AGENT
	fi
fi

source ~/.ssh-agent

