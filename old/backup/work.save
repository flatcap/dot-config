#!/bin/bash

title()
{
	local title=""

	case $1 in
	"")
		title="${PWD/#$HOME/~}"
		;;
	"-")
		;;
	*)
		title="$*"
		;;
	esac

	echo -ne "\033]0;${title}\007" > /dev/stderr
}


BASE_DIR="/home/flatcap"
WORK_DIR="work"
HOST_DIR="derwent:backup"
TITLE="dev.save:"
DERWENT_KEY="b8:45:36:71:bf:c9:92:1c:0b:92:d4:08:6c:aa:33:fb"

ssh-add -l | grep -q $DERWENT_KEY
if [ $? != 0 ]; then
	echo "SSH key not unlocked.  Won't be able to connect to 'derwent'"
	exit 1
fi

cd $BASE_DIR
title "$TITLE creating"
tar cfv $WORK_DIR.tar $WORK_DIR
title "$TITLE compressing"
xz -9v $WORK_DIR.tar
title "$TITLE transfering"
scp $WORK_DIR.tar.xz $HOST_DIR
title "$TITLE removing"
rm $WORK_DIR.tar.xz

