#!/bin/bash

set -o errexit	# set -e
set -o nounset	# set -u

umask 0077

function tidy()
{
	[ -n "$TMP_DIR" ] && rm --force --recursive "$TMP_DIR"
}

trap tidy EXIT

TMP_DIR=$(mktemp --directory)

STDOUT=$TMP_DIR/stdout
STDERR=$TMP_DIR/stderr
TRACE=$TMP_DIR/trace

exec 3> $TRACE
export PS4=
export BASH_XTRACEFD=3

set +o errexit
"$@" 1>$STDOUT 2>$STDERR
RETVAL=$?
set -o errexit

if [ $RETVAL -ne 0 -o -s "$STDERR" ]; then
	echo "Error in command: $@ ($RETVAL)"
	echo "STDERR:"
	sed 's/^/\t/' "$STDERR"
	echo
	echo "STDOUT:"
	sed 's/^/\t/' "$STDOUT"
	if [ -s $TRACE ]; then
		echo
		echo "TRACE:"
		sed 's/^/\t/' "$TRACE"
	fi
fi

